---
title: "Exploratory analysis"
author: "David Henderson"
date: "6 September 2018"
output:
  html_document:
    df_print: paged
    theme: spacelab
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(digits = 3)
```

# Intro

Building on Sumeet's intitial thoughts I want to get a quick look of the socioeonomic variables that might predict mortality.

##Packages

Load required packages

```{r libs}
library(tidyverse)
library(magrittr)
library(here)
library(DT)
library(ggthemes)
library(extrafont)
library(classInt)
theme_set(theme_minimal(base_size = 16, base_family = "Roboto"))
```

##Data

Load the cleaned data file

```{r load}
load(here("assets/clean_data/clean_data.rds"))
load(here("assets/clean_data/shapefile.rds"))
```


#Mortality by predictor

##Age group

```{r age_dead}
clean_data %>% 
  count(age_grp, dead) %>% 
  group_by(age_grp) %>% 
  mutate(frq = round(n/sum(n),4),
         pct = frq*100)  -> age_dead
datatable(age_dead, extensions = "Buttons", options = list(
  dom = "Bfrtip"))
```

plot it

```{r plot_age, fig.width=9}
age_dead %>% 
  filter(dead == "Dead") %>% 
  ggplot(aes(age_grp, frq)) +
  geom_col(fill = "#4477AA") +
  coord_flip() +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(title = "Percentage of indivudals who died",
       subtitle = "by Age group",
       x = "",
       y = "")
```

##Age at immigration

```{r label, options}
clean_data %>% 
  count(age_imm, dead) %>% 
  group_by(age_imm) %>% 
  mutate(frq = round(n/sum(n),4),
         pct = frq*100)  -> ageimm_dead
datatable(ageimm_dead, extensions = "Buttons", options = list(
  dom = "Bfrtip"))
```

plot

```{r plot-ageimm, fig.width=9}
ageimm_dead %>% 
  filter(dead == "Dead") %>% 
  ggplot(aes(age_imm, frq)) +
  geom_col(fill = "#4477AA") +
  coord_flip() +
  scale_y_continuous(labels = scales::percent_format(),
                     limits = c(0, 0.5)) +
  labs(title = "Percentage of indivudals who died",
       subtitle = "by Age group at immigration",
       x = "",
       y = "")
```


##Sex

```{r sex-dead}
clean_data %>% 
  count(sex, dead) %>% 
  group_by(sex) %>% 
  mutate(frq = round(n/sum(n),4),
         pct = frq*100)  -> sex_dead
datatable(sex_dead, extensions = "Buttons", options = list(
  dom = "Bfrtip"))
```

plot it

```{r plot_sex, fig.width=9}
sex_dead %>% 
  filter(dead == "Dead") %>% 
  ggplot(aes(sex, frq)) +
  geom_col(fill = "#4477AA") +
  scale_y_continuous(labels = scales::percent_format(),
                     limits = c(0, 0.1),
                     breaks = scales::pretty_breaks(n = 9)) +
  labs(title = "Percentage of indivudals who died",
       subtitle = "by Sex",
       x = "",
       y = "")
```

##Income decile


```{r count}
clean_data %>% 
  count(loinc_decile, dead) %>% 
  group_by(loinc_decile) %>% 
  mutate(frq = round(n/sum(n), 4),
         pct= frq*100)  -> inc_dead
datatable(inc_dead, extensions = "Buttons", options = list(
  dom = "Bfrtip"))
```

```{r plot_inc, fig.width=9}
inc_dead %>% 
  filter(dead == "Dead") %>% 
  ggplot(aes(loinc_decile, frq)) +
  geom_col(fill = "#4477AA") +
  scale_y_continuous(labels = scales::percent_format(),
                     limits = c(0, 0.16),
                     breaks = scales::pretty_breaks(n = 9)) +
  labs(title = "Percentage of indivudals who died",
       subtitle = "by income decile",
       x = "",
       y = "")
```

##Education

```{r edu-dead}
clean_data %>% 
  count(education, dead) %>% 
  group_by(education) %>% 
  mutate(frq = round(n/sum(n), 4),
         pct= frq*100)  -> edu_dead
datatable(edu_dead, extensions = "Buttons", options = list(
  dom = "Bfrtip"))
```

plot it

```{r plot-edu, fig.width = 9}
edu_dead %>% 
  filter(dead == "Dead") %>% 
  ggplot(aes(education, frq)) +
  geom_col(fill = "#4477AA") +
  scale_y_continuous(labels = scales::percent_format(),
                     limits = c(0, 0.18),
                     breaks = scales::pretty_breaks(n = 9)) +
  coord_flip() +
  labs(title = "Percentage of indivudals who died",
       subtitle = "by highest level of education obtained",
       x = "",
       y = "")
```

##Aboriginal identity

```{r abor-count}
clean_data %>% 
  count(ab_id_detailed, dead) %>% 
  group_by(ab_id_detailed) %>% 
  mutate(frq = round(n/sum(n), 4),
         pct= frq*100)  -> ab_dead
datatable(ab_dead, extensions = "Buttons", options = list(
  dom = "Bfrtip"))
```


plot it

```{r ad-dead, fig.width=9}
ab_dead %>% 
  filter(dead == "Dead") %>% 
  ggplot(aes(ab_id_detailed, frq)) +
  geom_col(fill = "#4477AA") +
  scale_y_continuous(labels = scales::percent_format(),
                     limits = c(0, 0.12),
                     breaks = scales::pretty_breaks(n = 9)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  labs(title = "Percentage of indivudals who died",
       subtitle = "by Aboriginal identity",
       x = "",
       y = "")
```


## Province of residence

```{r prov, options}
clean_data %>% 
  count(province, dead) %>% 
  group_by(province) %>% 
  mutate(frq = round(n/sum(n), 4),
         pct= frq*100)  -> prov_dead
datatable(prov_dead, extensions = "Buttons", options = list(
  dom = "Bfrtip"))
```

plot it

```{r plot-prov, fig.width=9}
prov_dead %>% 
  filter(dead == "Dead") %>% 
  ggplot(aes(province, frq)) +
  geom_col(fill = "#4477AA") +
  scale_y_continuous(labels = scales::percent_format(),
                     limits = c(0, 0.1),
                     breaks = scales::pretty_breaks(n = 9)) +
  coord_flip() +
  labs(title = "Percentage of indivudals who died",
       subtitle = "by Province of residence",
       x = "",
       y = "")
```

and a map

```{r map_prov, fig.width=9, fig.height=6}
prov_dead %<>%
  filter(dead == "Dead") 

classes <- classIntervals(prov_dead$pct, n = 5, style = "equal")

prov_dead %<>%
  mutate(pct_class = cut(pct, classes$brks, include.lowest = TRUE))

prov_dead %>% 
  left_join(., shapefile) %>% 
  ggplot(.) +
  geom_sf(aes(fill = pct_class),
          colour = "black",
          size = 0.3) +
  scale_fill_brewer(palette = "Blues", 
                    name = "Mortality rate %") +
  theme(line = element_blank(),
        axis.text = element_blank(),
        panel.grid = element_line(colour = "transparent"),
        legend.position = "bottom") +
  labs(title = "Mortality rate (%)",
       subtitle = "by Province")
```


##Activities of daily living

```{r adl-dead}
clean_data %>% 
  count(adl_difficulty, dead) %>% 
  group_by(adl_difficulty) %>% 
  mutate(frq = round(n/sum(n), 4),
         pct= frq*100)  -> adl_dead
datatable(adl_dead, extensions = "Buttons", options = list(
  dom = "Bfrtip"))
```

```{r plot-adl, fig.width=9}
adl_dead %>% 
  filter(dead == "Dead") %>% 
  ggplot(aes(adl_difficulty, frq)) +
  geom_col(fill = "#4477AA") +
  scale_y_continuous(labels = scales::percent_format(),
                     limits = c(0, 0.35),
                     breaks = scales::pretty_breaks(n = 9)) +
  labs(title = "Percentage of indivudals who died",
       subtitle = "by stated difficulty with Activities of Daily Living",
       x = "",
       y = "")
```

##Country of birth

```{r birth}
clean_data %>% 
  count(birth_country, age_grp, dead) %>% 
  group_by(birth_country, age_grp) %>% 
  mutate(frq = round(n/sum(n), 4),
         pct= frq*100)  -> birth_dead
datatable(birth_dead, extensions = "Buttons", options = list(
  dom = "Bfrtip"))
```

```{r birth_2, fig.width=14, fig.height=10}
birth_dead %>% 
  filter(dead == "Dead") %>% 
  ggplot(aes(birth_country, frq, fill = birth_country)) +
  geom_col() +
  scale_fill_ptol() +
  facet_wrap(~ age_grp) +
  scale_y_continuous(labels = scales::percent_format(),
                     breaks = scales::pretty_breaks()) +
  labs(title = "Percentage of indivudals who died",
       subtitle = "by age group and country of birth",
       x = "",
       y = "", 
       fill = "Country of\nbirth") +
  theme(legend.position = "bottom", 
        axis.text.x = element_blank())
```








